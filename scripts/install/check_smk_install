#!/bin/csh -f

# This script checks to see if the SMOKE installation worked successfully

set errfile = $SCRIPTS/install/.err

# Set environment variables for getting QA_SETUP environment variables
setenv MRG_SOURCE ABMP
setenv RUN_SMKMERGE Y
setenv MRG_TEMPORAL_YN Y
setenv MRG_SPCMAT_YN Y
setenv MRG_REPSTA_YN Y

# Get E.V.s from Assigns file
source $SMKROOT/assigns/ASSIGNS.nctox.cmaq.cb4p25_wtox.us36-nc

# Check stationary area sources
echo 'Stationary area source differences' > $errfile
diff $REPSCEN/agt.state*191* $SMKROOT/doc/checkdemo/reports/agt.state*191* >> $errfile
set ar_stat = $status
diff $REPSCEN/ats.scc*191* $SMKROOT/doc/checkdemo/reports/ats.scc*191* >> $errfile
set ar_stat = $status

# Check biogenic sources
echo 'Biogenic source differences' >> $errfile
diff $REPBGTS_L $SMKROOT/doc/checkdemo/reports/repbgts_l.* >> $errfile
set bg_stat = $status

# Check mobile sources
echo 'Mobile source differences' >> $errfile
diff $REPSCEN/mgt.state*191* $SMKROOT/doc/checkdemo/reports/mgt.state*191* >> $errfile
set mb_stat = $status
diff $REPSCEN/mts.scc*191* $SMKROOT/doc/checkdemo/reports/mts.scc*191* >> $errfile
set mb_stat = $status

# Check nonroad area sources
echo 'Nonroad source differences' >> $errfile
diff $REPSCEN/ngt.state*191* $SMKROOT/doc/checkdemo/reports/ngt.state*191* >> $errfile
set nr_stat = $status
diff $REPSCEN/nts.scc*191* $SMKROOT/doc/checkdemo/reports/nts.scc*191* >> $errfile
set nr_stat = $status

# Check point sources
echo 'Point source differences' >> $errfile
diff $REPSCEN/pgt.state*191* $SMKROOT/doc/checkdemo/reports/pgt.state*191* >> $errfile
set pt_stat = $status
diff $REPSCEN/pts.scc*191* $SMKROOT/doc/checkdemo/reports/pts.scc*191* >> $errfile
set pt_stat = $status

# Unset environment variables to allow grep to work:
unsetenv AG*_L AG*_S MG*_L MG*_S PG*_L PG*_S BG*_L BG*_S NG*_L NG*_S EG*_L EG*_S

# Make sure all programs completed successfully
set num_log_file = `ls $LOGS | wc -l`
set sav_dir = `pwd`
cd $LOGS
set num_success = `grep 'Normal Completion' * | wc -l`
if( $num_log_file != $num_success ) then
   echo ' '
   echo 'All programs in your installation did not complete successfully\!'
   echo 'Please look at the log files in $LOGS for more information.'
   echo ' '
endif
cd $sav_dir

if ( $ar_stat != 0 || $bg_stat != 0 || $mb_stat != 0 || $nr_stat != 0 || $pt_stat != 0 ) then
   mv $errfile $SMKROOT/doc/install_diffs.txt
   echo ' '
   echo 'Differences between your installation and correct answers exist\!'
   echo 'Please refer to file $SMKROOT/doc/install_diffs.txt for details.'
   echo ' '
else
   echo ' '
   echo 'No difference found between your log files and the comparison files.'
   echo 'Your installation and example SMOKE run have completed successfully\!'
   echo ' '
   rm -rf $errfile
endif
